<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Pacotes e Paradas - ML Deluna</title>
    <link rel="manifest" href="manifest.json">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background-color: #1e1e1e;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }
        .logo {
            display: block;
            margin: 0 auto 10px;
            width: 250px;
            max-width: 100%;
        }
        h1 {
            text-align: center;
            color: #ffffff;
            margin-top: 0;
            font-size: 1.5em;
        }
        h2 {
            text-align: center;
            color: #ffffff;
            font-size: 1.3em;
            margin-bottom: 20px;
        }
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        .tab-button {
            background-color: #2a2a2a;
            border: 1px solid #444;
            border-bottom: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
            border-radius: 5px 5px 0 0;
            color: #e0e0e0;
        }
        .tab-button.active {
            background-color: #3e5c9b;
            color: white;
            border-color: #3e5c9b;
        }
        .tab-content {
            display: none;
            padding-top: 20px;
        }
        .tab-content.active {
            display: block;
        }
        .form {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .form-paradas {
            justify-content: center;
        }
        input, button {
            flex: 1;
            padding: 12px;
            border: 1px solid #444;
            border-radius: 5px;
            font-size: 16px;
            background-color: #2a2a2a;
            color: #e0e0e0;
        }
        button {
            background-color: #3e5c9b;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #4b68a7;
        }
        .form-paradas input {
            max-width: 250px;
        }
        .form-paradas button {
            max-width: 250px;
        }
        .total-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #2a2a2a;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .total-info {
            font-size: 1.2em;
            font-weight: bold;
            color: #e0e0e0;
        }
        .total-value {
            color: #6a9bd2;
        }
        .total-insucesso {
            color: #dc3545;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 8px;
            border-bottom: 1px solid #444;
            text-align: left;
            vertical-align: top;
        }
        th {
            background-color: #3e5c9b;
            color: white;
            position: sticky;
            top: 0;
        }
        #recordsTable th:nth-child(1),
        #recordsTable td:nth-child(1) { width: 20%; }
        #recordsTable th:nth-child(2),
        #recordsTable td:nth-child(2) { width: 15%; }
        #recordsTable th:nth-child(3),
        #recordsTable td:nth-child(3) { width: 30%; }
        #recordsTable th:nth-child(4),
        #recordsTable td:nth-child(4) { width: 15%; text-align: center; }
        #recordsTable th:nth-child(5),
        #recordsTable td:nth-child(5) { width: 20%; text-align: right; }
        #stopsTable th:nth-child(1),
        #stopsTable td:nth-child(1) { width: 15%; }
        #stopsTable th:nth-child(2),
        #stopsTable td:nth-child(2) { width: 10%; text-align: center; }
        #stopsTable th:nth-child(3),
        #stopsTable td:nth-child(3) { width: 65%; }
        #stopsTable th:nth-child(4),
        #stopsTable td:nth-child(4) { width: 10%; text-align: right; }
        #stopsTable th:nth-child(5),
        #stopsTable td:nth-child(5) { width: 10%; text-align: center; }
        .actions {
            display: flex;
            gap: 5px;
            justify-content: flex-end;
            align-items: center;
        }
        .edit-btn, .delete-btn, .add-btn, .photo-btn {
            padding: 6px 4px;
            border-radius: 3px;
            cursor: pointer;
            border: none;
            color: white;
            font-weight: bold;
        }
        .add-btn {
            background-color: #28a745;
        }
        .edit-btn {
            background-color: #007bff;
        }
        .delete-btn {
            background-color: #dc3545;
        }
        .photo-btn {
            background-color: #ffc107;
            font-size: 10px;
        }
        .observation-field {
            width: 100%;
            min-height: 30px;
            box-sizing: border-box;
            background-color: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 8px;
            font-family: Arial, sans-serif;
            resize: vertical;
            transition: background-color 0.3s ease;
        }
        .filled-observation {
            background-color: #4a2c2c;
        }
        #total-date-filter {
            text-align: right;
        }
        .stop-row.completed {
            background-color: #2a3a2a;
            opacity: 0.8;
            text-decoration: line-through;
        }
        .stop-row.completed td {
            color: #a0a0a0;
        }
        .completed-checkbox {
            cursor: pointer;
            width: 18px;
            height: 18px;
        }
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .button-group button {
            flex: 1;
            min-width: 120px;
        }
        .hidden-file-input {
            display: none;
        }
        .record-row {
            cursor: pointer;
        }
        /* Estilos para os pop-ups customizados */
        .custom-popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .custom-popup {
            background-color: #1e1e1e;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            max-width: 300px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .custom-popup-content {
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            max-width: 350px;
            width: 90%;
            text-align: center;
            position: relative; /* Adicionado para posicionar o botão de fechar */
        }
        .custom-popup-content h3 {
            margin-top: 0;
            color: #fff;
            font-size: 1.5em;
        }
        .custom-popup-content p {
            font-size: 1.2em;
            color: #e0e0e0;
        }
        .custom-popup-details {
            text-align: left;
            padding: 0 10px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .custom-popup-details h3, .custom-popup-details h4 {
            color: #3e5c9b;
            margin: 10px 0 5px;
        }
        .custom-popup-details p {
            font-size: 1em;
            margin: 5px 0;
        }
        .custom-popup-details .value {
            color: #6a9bd2;
            font-weight: bold;
        }
        .custom-popup-details ul {
            list-style-type: none;
            padding: 0;
        }
        .custom-popup-details li {
            margin-bottom: 8px;
            padding: 5px;
            border-radius: 5px;
            background-color: #2a2a2a;
        }
        .gains-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .gains-table th, .gains-table td {
            padding: 8px;
            border: 1px solid #444;
            text-align: left;
        }
        .gains-table th {
            background-color: #3e5c9b;
            color: white;
            position: sticky;
            top: 0;
        }
        .gains-table .week-total-row {
            background-color: #2a2a2a;
            font-weight: bold;
            color: #6a9bd2;
        }

        /* Estilos para o novo popup de observações */
        .observation-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .observation-popup-content {
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            max-width: 350px;
            width: 90%;
            text-align: center;
        }
        .observation-popup-content h3 {
            margin-top: 0;
            color: #fff;
        }
        .observation-options {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .observation-options button {
            background-color: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #444;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .observation-options button:hover {
            background-color: #3e5c9b;
        }
        .observation-popup-content textarea {
            width: 100%;
            min-height: 80px;
            background-color: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 10px;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
            resize: vertical;
            margin-bottom: 10px;
        }
        .observation-popup-actions {
            display: flex;
            justify-content: space-around;
            gap: 10px;
        }
        /* Estilos para o botão de fechar do pop-up de foto */
        .close-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background-color: #dc3545;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .close-btn:hover {
            background-color: #c82333;
        }

        @media (max-width: 600px) {
            .company-name { font-size: 1.4em; }
            h1 { font-size: 1.2em; }
            .total-container { font-size: 1em; padding: 8px; }
            input, button { font-size: 14px; padding: 10px; }
            table { font-size: 12px; }
            th, td { padding: 8px; }
            #recordsTable th:nth-child(1), #recordsTable td:nth-child(1),
            #recordsTable th:nth-child(2), #recordsTable td:nth-child(2),
            #recordsTable th:nth-child(3), #recordsTable td:nth-child(3),
            #recordsTable th:nth-child(4), #recordsTable td:nth-child(4),
            #recordsTable th:nth-child(5), #recordsTable td:nth-child(5) { width: auto; }
            #stopsTable th:nth-child(1), #stopsTable td:nth-child(1),
            #stopsTable th:nth-child(2), #stopsTable td:nth-child(2),
            #stopsTable th:nth-child(3), #stopsTable td:nth-child(3),
            #stopsTable th:nth-child(4), #stopsTable td:nth-child(4),
            #stopsTable th:nth-child(5), #stopsTable td:nth-child(5) { width: auto; }
            .edit-btn, .delete-btn, .add-btn { padding: 4px 6px; font-size: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <img src="IMG_20250816_204625.jpg" alt="Logo ML Deluna" class="logo">
        <h1>Registros</h1>
        <div class="tabs">
            <button class="tab-button active" onclick="openTab('paradas', 0)">Paradas</button>
            <button class="tab-button" onclick="openTab('pacotes', 1)">Pacotes</button>
            <button class="tab-button" onclick="openTab('gains', 2)">Ganhos</button>
        </div>
        <div id="paradas" class="tab-content active">
            <div class="form form-paradas">
                <input type="number" id="stopNumber" placeholder="Número da Parada" required min="1">
                <input type="number" id="quantity-paradas" placeholder="Quantidade de Pacotes" required min="0">
                <button id="saveStopBtn" onclick="saveStopRecord()">Salvar Parada</button>
            </div>
            <div class="button-group">
                <button id="finishRouteBtn" onclick="finishRoute()">Finalizar Rota</button>
            </div>
            <div class="total-container">
                <div class="total-info">Quantidade total: <span id="totalStopsCount" class="total-value">0</span></div>
            </div>
            <div class="table-container">
                <table id="stopsTable">
                    <thead>
                        <tr>
                            <th>Parada</th>
                            <th>QTD</th>
                            <th>Observação</th>
                            <th>Foto</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="stopsTableBody"></tbody>
                </table>
            </div>
        </div>
        <div id="pacotes" class="tab-content">
            <div class="form">
                <input type="date" id="date-pacotes" required>
                <input type="number" id="quantity-pacotes" placeholder="Quantidade de Pacotes" required min="0">
                <input type="text" id="route-pacotes" placeholder="Rota" required>
                <input type="text" id="driver-pacotes" list="driver-list" placeholder="Nome do Motorista" required>
                <datalist id="driver-list"></datalist>
                <button onclick="addOrUpdateRecord()">Adicionar</button>
            </div>
            <div class="button-group">
                <button onclick="exportData()">Exportar Dados</button>
                <button onclick="document.getElementById('file-input').click()">Importar Dados</button>
                <input type="file" id="file-input" accept=".json" class="hidden-file-input" onchange="importData(event)">
            </div>
            <div class="total-container">
                <input type="date" id="total-date-filter">
                <div class="total-info">Total de pacotes: <span id="totalPackagesCount" class="total-value">0</span></div>
            </div>
            <div class="table-container">
                <table id="recordsTable">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Rota</th>
                            <th>Motorista</th>
                            <th>QTD</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
        <div id="gains" class="tab-content">
            <h2>Ganhos por Semana</h2>
            <div class="table-container">
                <table class="gains-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Pacotes</th>
                            <th>Ganhos (R$)</th>
                        </tr>
                    </thead>
                    <tbody id="gainsTableBody"></tbody>
                </table>
            </div>
        </div>
        <div id="routeDetails" class="tab-content">
            <h2>Detalhes da Rota: <span id="routeDetailsTitle"></span></h2>
            <div class="total-container">
                <div class="total-info">Total de pacotes: <span id="totalRouteDetailsCount" class="total-value">0</span></div>
                <div class="total-info">Total de insucessos: <span id="totalInsucessoCount" class="total-value total-insucesso">0</span></div>
            </div>
            <div class="table-container">
                <table id="detailsTable">
                    <thead>
                        <tr>
                            <th>Parada</th>
                            <th>QTD</th>
                            <th>Observação</th>
                            <th>Foto</th>
                        </tr>
                    </thead>
                    <tbody id="routeDetailsTableBody">
                        </tbody>
                </table>
            </div>
            <button onclick="hideRouteDetails()">Voltar</button>
        </div>
    </div>
    
    <div id="customPopupOverlay" class="custom-popup-overlay">
        <div class="custom-popup">
            <div class="custom-popup-content">
                <h3 id="popupDate"></h3>
                <p id="popupValue"></p>
                <div class="button-group">
                    <button onclick="closeCustomPopup()">Fechar</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="observationPopupOverlay" class="observation-popup">
        <div class="observation-popup-content">
            <h3>Observação da Parada</h3>
            <div class="observation-options">
                <button onclick="addObservationText('Mochila')">Mochila</button>
                <button onclick="addObservationText('Grande')">Grande</button>
            </div>
            <textarea id="observationTextarea"></textarea>
            <div class="observation-popup-actions">
                <button onclick="saveObservation()">Salvar</button>
                <button onclick="closeObservationPopup()">Cancelar</button>
            </div>
        </div>
    </div>
    
    <div id="fullPhotoPopupOverlay" class="custom-popup-overlay" onclick="closeFullPhotoPopup()">
        <div class="custom-popup-content" onclick="event.stopPropagation();">
            <img id="fullPhoto" src="" style="max-width: 90vw; max-height: 90vh; object-fit: contain;">
            <span class="close-btn" onclick="closeFullPhotoPopup();">X</span>
        </div>
    </div>

    <script>
        // Variável global para rastrear a aba ativa
        let currentTabIndex = 0;
        const tabNames = ['paradas', 'pacotes', 'gains'];

        // Variável para armazenar dados localmente antes de salvar
        let records = [];
        let drivers = [];
        let stops = JSON.parse(localStorage.getItem('stops')) || [];
        let editIndex = -1;
        let editStopIndex = -1;
        let currentObservationIndex = -1;

        const monthNames = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
        const dayNames = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sáb"];

        const API_URL = '/.netlify/functions/';

        function openTab(tabName, tabIndex) {
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => tab.classList.remove('active'));
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => button.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            
            const button = document.querySelector(`.tab-button[onclick*="openTab('${tabName}')"]`);
            if (button) {
                button.classList.add('active');
            }
            
            currentTabIndex = tabIndex;

            if (tabName === 'gains') {
                updateGainsTable();
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            const day = String(date.getDate()).padStart(2, '0');
            const month = monthNames[date.getMonth()];
            const dayOfWeek = dayNames[date.getDay()];
            return `${day} ${month}<br>(${dayOfWeek})`;
        }

        function formatFullDate(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function populateDriverDatalist() {
            const driverList = document.getElementById('driver-list');
            driverList.innerHTML = '';
            const uniqueDrivers = [...new Set(drivers)].sort();
            uniqueDrivers.forEach(driver => {
                const option = document.createElement('option');
                option.value = driver;
                driverList.appendChild(option);
            });
        }

        function calculateTotalByDate(selectedDate) {
            if (!selectedDate) {
                const total = records.reduce((sum, record) => sum + Number(record.quantity), 0);
                document.getElementById('totalPackagesCount').textContent = total;
                return;
            }
            const total = records.filter(record => record.date === selectedDate).reduce((sum, record) => sum + Number(record.quantity), 0);
            document.getElementById('totalPackagesCount').textContent = total;
        }

        async function loadRecords() {
            try {
                const response = await fetch(`${API_URL}get-records`);
                if (!response.ok) {
                    throw new Error('Erro ao carregar dados do banco de dados.');
                }
                const data = await response.json();
                records = data.records;
                drivers = data.drivers;
                
                const tableBody = document.getElementById('tableBody');
                tableBody.innerHTML = '';
                
                const sortedRecords = records.sort((a, b) => new Date(b.date) - new Date(a.date));
                sortedRecords.forEach((record, index) => {
                    const row = document.createElement('tr');
                    row.classList.add('record-row');
                    row.onclick = () => showRouteDetails(record.date, record.route);
                    row.innerHTML = `
                        <td>${formatDate(record.date)}</td>
                        <td>${record.route || record.initials || ''}</td>
                        <td>${record.driver}</td>
                        <td><b>${record.quantity}</b></td>
                        <td class="actions">
                            <button class="add-btn" onclick="event.stopPropagation(); addQuantity('${record.id}');">+</button>
                            <button class="edit-btn" onclick="event.stopPropagation(); editRecord('${record.id}');">E</button>
                            <button class="delete-btn" onclick="event.stopPropagation(); deleteRecord('${record.id}');">-</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                calculateTotalByDate(document.getElementById('total-date-filter').value);
                populateDriverDatalist();

            } catch (error) {
                console.error('Erro ao carregar registros:', error);
                alert('Não foi possível carregar os dados. Verifique sua conexão ou tente novamente mais tarde.');
            }
        }

        async function addOrUpdateRecord() {
            const date = document.getElementById('date-pacotes').value;
            const quantity = document.getElementById('quantity-pacotes').value;
            const route = document.getElementById('route-pacotes').value;
            const driver = document.getElementById('driver-pacotes').value;
            const recordId = document.getElementById('addRecordBtn').dataset.recordId;

            if (!date || !quantity || !route || !driver) {
                alert('Por favor, preencha todos os campos.');
                return;
            }

            const record = { id: recordId, date, quantity: Number(quantity), route, driver };

            try {
                const response = await fetch(`${API_URL}save-record`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(record)
                });
                if (!response.ok) {
                    throw new Error('Erro ao salvar o registro no banco de dados.');
                }
                await loadRecords();
                clearFormPacotes();
                document.getElementById('addRecordBtn').textContent = 'Adicionar';
                document.getElementById('addRecordBtn').dataset.recordId = '';
            } catch (error) {
                console.error('Erro ao salvar registro:', error);
                alert('Ocorreu um erro ao salvar o registro. Tente novamente.');
            }
        }

        function editRecord(id) {
            const record = records.find(rec => rec.id === id);
            if (!record) return;

            document.getElementById('date-pacotes').value = record.date;
            document.getElementById('quantity-pacotes').value = record.quantity;
            document.getElementById('route-pacotes').value = record.route || '';
            document.getElementById('driver-pacotes').value = record.driver;

            const addBtn = document.getElementById('addRecordBtn');
            addBtn.textContent = 'Atualizar';
            addBtn.dataset.recordId = id;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function addQuantity(id) {
            const quantityToAdd = prompt("Quantos pacotes você deseja somar?");
            if (quantityToAdd !== null && !isNaN(quantityToAdd) && quantityToAdd !== "") {
                try {
                    const response = await fetch(`${API_URL}add-quantity`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id, quantity: Number(quantityToAdd) })
                    });
                    if (!response.ok) {
                        throw new Error('Erro ao somar a quantidade.');
                    }
                    await loadRecords();
                } catch (error) {
                    console.error('Erro ao adicionar quantidade:', error);
                    alert('Ocorreu um erro ao adicionar a quantidade. Tente novamente.');
                }
            } else if (quantityToAdd !== null) {
                alert("Por favor, insira um número válido.");
            }
        }

        function clearFormPacotes() {
            document.getElementById('date-pacotes').value = '';
            document.getElementById('quantity-pacotes').value = '';
            document.getElementById('route-pacotes').value = '';
            document.getElementById('driver-pacotes').value = '';
        }

        async function deleteRecord(id) {
            if (confirm('Tem certeza que deseja excluir este registro?')) {
                try {
                    const response = await fetch(`${API_URL}delete-record`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id })
                    });
                    if (!response.ok) {
                        throw new Error('Erro ao excluir o registro.');
                    }
                    await loadRecords();
                } catch (error) {
                    console.error('Erro ao excluir registro:', error);
                    alert('Ocorreu um erro ao excluir o registro. Tente novamente.');
                }
            }
        }

        document.getElementById('total-date-filter').addEventListener('change', (e) => {
            calculateTotalByDate(e.target.value);
        });

        function saveStopRecord() {
            const stopNumber = document.getElementById('stopNumber').value;
            const quantity = document.getElementById('quantity-paradas').value;
            if (!stopNumber || !quantity) {
                alert('Por favor, preencha todos os campos.');
                return;
            }
            if (editStopIndex === -1) {
                const record = { stopNumber: Number(stopNumber), quantity: Number(quantity), completed: false, observations: '', photo: '' };
                stops.push(record);
            } else {
                stops[editStopIndex].stopNumber = Number(stopNumber);
                stops[editStopIndex].quantity = Number(quantity);
                editStopIndex = -1;
                document.getElementById('saveStopBtn').textContent = 'Salvar Parada';
            }
            localStorage.setItem('stops', JSON.stringify(stops));
            loadStopRecords();
            clearFormParadas();
        }

        function loadStopRecords() {
            const tableBody = document.getElementById('stopsTableBody');
            tableBody.innerHTML = '';
            stops.sort((a, b) => a.stopNumber - b.stopNumber);
            stops.forEach((stop, index) => {
                const row = document.createElement('tr');
                row.classList.add('stop-row');
                if (stop.completed) {
                    row.classList.add('completed');
                }
                const observationClass = stop.observations.trim() !== '' ? 'filled-observation' : '';
                const photoCellContent = stop.photo 
                    ? `<span style="cursor:pointer;" onclick="showFullPhoto('${stop.photo}')">📸</span>` 
                    : 'N/A';
                row.innerHTML = `
                    <td>${stop.stopNumber}</td>
                    <td><b>${stop.quantity}</b></td>
                    <td>
                        <textarea class="observation-field ${observationClass}" readonly onclick="openObservationPopup(${index});">${stop.observations}</textarea>
                    </td>
                    <td style="text-align: center;">${photoCellContent}</td>
                    <td class="actions">
                        <input type="checkbox" class="completed-checkbox" ${stop.completed ? 'checked' : ''} onclick="event.stopPropagation(); toggleStopCompletion(${index});">
                        <label for="photo-input-${index}" class="photo-btn">📷</label>
                        <input type="file" id="photo-input-${index}" accept="image/*" capture="camera" class="hidden-file-input" onchange="handlePhotoCapture(${index}, event)">
                        <button class="edit-btn" onclick="event.stopPropagation(); editStopRecord(${index});">E</button>
                        <button class="delete-btn" onclick="event.stopPropagation(); deleteStopRecord(${index});">X</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            const total = stops.reduce((sum, stop) => sum + (Number(stop.quantity) || 0), 0);
            document.getElementById('totalStopsCount').textContent = total;
        }

        function handlePhotoCapture(index, event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onloadend = () => {
                stops[index].photo = reader.result;
                localStorage.setItem('stops', JSON.stringify(stops));
                loadStopRecords();
            };
            reader.readAsDataURL(file);
        }

        function openObservationPopup(index) {
            currentObservationIndex = index;
            const currentObservation = stops[index].observations;
            document.getElementById('observationTextarea').value = currentObservation;
            document.getElementById('observationPopupOverlay').style.display = 'flex';
        }

        function closeObservationPopup() {
            document.getElementById('observationPopupOverlay').style.display = 'none';
        }

        function addObservationText(text) {
            const textarea = document.getElementById('observationTextarea');
            const currentValue = textarea.value;
            if (currentValue.includes(text)) {
                const updatedValue = currentValue.split(', ').filter(t => t !== text).join(', ');
                textarea.value = updatedValue;
            } else {
                textarea.value = currentValue ? `${currentValue}, ${text}` : text;
            }
        }

        function saveObservation() {
            const newObservation = document.getElementById('observationTextarea').value;
            if (currentObservationIndex !== -1) {
                stops[currentObservationIndex].observations = newObservation;
                localStorage.setItem('stops', JSON.stringify(stops));
                loadStopRecords();
            }
            closeObservationPopup();
        }

        function toggleStopCompletion(index) {
            stops[index].completed = !stops[index].completed;
            localStorage.setItem('stops', JSON.stringify(stops));
            loadStopRecords();
        }

        function editStopRecord(index) {
            const record = stops[index];
            document.getElementById('stopNumber').value = record.stopNumber;
            document.getElementById('quantity-paradas').value = record.quantity;
            editStopIndex = index;
            document.getElementById('saveStopBtn').textContent = 'Atualizar Parada';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function clearFormParadas() {
            document.getElementById('stopNumber').value = '';
            document.getElementById('quantity-paradas').value = '';
        }

        function deleteStopRecord(index) {
            if (confirm('Tem certeza que deseja excluir este registro?')) {
                stops.splice(index, 1);
                localStorage.setItem('stops', JSON.stringify(stops));
                loadStopRecords();
            }
        }

        async function finishRoute() {
            if (stops.length === 0) {
                alert('Não há paradas para finalizar.');
                return;
            }
            
            const routeName = prompt('Digite o nome da rota a ser finalizada:');
            if (!routeName) {
                alert('A finalização da rota foi cancelada.');
                return;
            }

            const recordToUpdate = records.find(record => (record.route || '').toLowerCase() === routeName.toLowerCase());
            if (!recordToUpdate) {
                alert('Rota não encontrada. Verifique se o nome está correto.');
                return;
            }

            let totalPackagesInStops = 0;
            const stopDetails = stops.map(stop => {
                totalPackagesInStops += Number(stop.quantity) || 0;
                const isFailed = !stop.completed || stop.observations.toLowerCase().includes('insuc');
                return {
                    stopNumber: stop.stopNumber,
                    quantity: stop.quantity,
                    observations: stop.observations,
                    isFailed: isFailed,
                    photo: stop.photo
                };
            });

            try {
                const response = await fetch(`${API_URL}update-record`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        id: recordToUpdate.id,
                        quantity: totalPackagesInStops,
                        stopDetails: stopDetails
                    })
                });
                if (!response.ok) {
                    throw new Error('Erro ao finalizar a rota.');
                }

                stops = [];
                localStorage.setItem('stops', JSON.stringify(stops));
                
                await loadRecords();
                loadStopRecords();
                alert(`A rota "${routeName}" foi finalizada e os dados de paradas foram salvos.`);
            } catch (error) {
                console.error('Erro ao finalizar rota:', error);
                alert('Ocorreu um erro ao finalizar a rota. Tente novamente.');
            }
        }

        function showRouteDetails(date, route) {
            openTab('routeDetails', -1);
            const record = records.find(rec => rec.date === date && rec.route === route);
            
            if (!record) {
                document.getElementById('routeDetailsTitle').textContent = `Detalhes de Rota Não Encontrados`;
                const detailsTableBody = document.getElementById('routeDetailsTableBody');
                detailsTableBody.innerHTML = `<tr><td colspan="4">Dados de rota não encontrados no banco de dados.</td></tr>`;
                document.getElementById('totalRouteDetailsCount').textContent = '0';
                document.getElementById('totalInsucessoCount').textContent = '0';
                return;
            }

            document.getElementById('routeDetailsTitle').textContent = `${formatDate(record.date)} - Rota: ${record.route}`;
            const detailsTableBody = document.getElementById('routeDetailsTableBody');
            detailsTableBody.innerHTML = '';
            
            let totalPackagesInStops = 0;
            let failedCount = 0;
            
            if (record.stopDetails && record.stopDetails.length > 0) {
                record.stopDetails.forEach(stop => {
                    const row = document.createElement('tr');
                    totalPackagesInStops += Number(stop.quantity) || 0;
                    if (stop.isFailed) {
                        failedCount++;
                        row.style.backgroundColor = 'rgba(220, 53, 69, 0.2)';
                    }
                    const photoCellContent = stop.photo 
                        ? `<span style="cursor:pointer;" onclick="showFullPhoto('${stop.photo}')">📸</span>` 
                        : 'N/A';
                    row.innerHTML = `
                        <td>${stop.stopNumber}</td>
                        <td>${stop.quantity}</td>
                        <td>${stop.observations || 'N/A'}</td>
                        <td style="text-align: center;">${photoCellContent}</td>
                    `;
                    detailsTableBody.appendChild(row);
                });
            } else {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="4">Nenhum detalhe de parada para esta rota.</td>`;
                detailsTableBody.appendChild(row);
            }

            document.getElementById('totalRouteDetailsCount').textContent = totalPackagesInStops;
            document.getElementById('totalInsucessoCount').textContent = failedCount;
        }

        function hideRouteDetails() {
            openTab('pacotes', 1);
        }

        function exportData() {
            const data = {
                records: records,
                stops: stops,
                drivers: drivers
            };
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'dados_deluna.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData.records && importedData.stops && importedData.drivers) {
                        records = importedData.records;
                        stops = importedData.stops;
                        drivers = importedData.drivers;
                        localStorage.setItem('stops', JSON.stringify(stops));
                        
                        importedData.records.forEach(record => {
                            fetch(`${API_URL}save-record`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(record)
                            }).catch(error => console.error('Erro ao importar registro:', error));
                        });

                        loadRecords();
                        loadStopRecords();
                        alert('Dados importados com sucesso para a sessão local e enviados para o banco de dados. Pode levar um tempo para todos os registros aparecerem.');
                    } else {
                        alert('Formato de arquivo JSON inválido.');
                    }
                } catch (error) {
                    alert('Erro ao processar o arquivo. Certifique-se de que é um arquivo JSON válido.');
                }
            };
            reader.readAsText(file);
        }

        function showCustomPopup(date, value) {
            document.getElementById('popupDate').textContent = `Data: ${date}`;
            document.getElementById('popupValue').textContent = `R$ ${value}`;
            document.getElementById('customPopupOverlay').style.display = 'flex';
        }

        function closeCustomPopup() {
            document.getElementById('customPopupOverlay').style.display = 'none';
        }

        function getWeekStartDate(date) {
            const d = new Date(date + 'T00:00:00');
            const dayOfWeek = d.getDay();
            const diff = d.getDate() - dayOfWeek;
            return new Date(d.setDate(diff)).toISOString().slice(0, 10);
        }

        function updateGainsTable() {
            const tableBody = document.getElementById('gainsTableBody');
            tableBody.innerHTML = '';
            
            const dailyTotals = {};
            records.forEach(record => {
                if (!dailyTotals[record.date]) {
                    dailyTotals[record.date] = { packages: 0, gains: 0 };
                }
                const packages = record.quantity;
                const gains = packages * 2.50;
                dailyTotals[record.date].packages += packages;
                dailyTotals[record.date].gains += gains;
            });
            
            const weeklyGains = {};
            Object.keys(dailyTotals).forEach(dateString => {
                const weekKey = getWeekStartDate(dateString);
                
                if (!weeklyGains[weekKey]) {
                    weeklyGains[weekKey] = { total: 0, days: [] };
                }
                
                weeklyGains[weekKey].total += dailyTotals[dateString].gains;
                weeklyGains[weekKey].days.push({ 
                    date: dateString, 
                    packages: dailyTotals[dateString].packages, 
                    gains: dailyTotals[dateString].gains 
                });
            });
            
            const sortedWeeks = Object.keys(weeklyGains).sort((a, b) => new Date(b) - new Date(a));
            
            sortedWeeks.forEach(weekKey => {
                const weekData = weeklyGains[weekKey];
                
                weekData.days.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(day => {
                    const dayRow = document.createElement('tr');
                    dayRow.innerHTML = `
                        <td>${formatDate(day.date)}</td>
                        <td>${day.packages}</td>
                        <td>R$ ${day.gains.toFixed(2).replace('.', ',')}</td>
                    `;
                    tableBody.appendChild(dayRow);
                });
                
                const totalRow = document.createElement('tr');
                totalRow.classList.add('week-total-row');
                totalRow.innerHTML = `
                    <td>Total da Semana</td>
                    <td></td>
                    <td>R$ ${weekData.total.toFixed(2).replace('.', ',')}</td>
                `;
                tableBody.appendChild(totalRow);
            });
        }

        let touchstartX = 0;
        let touchendX = 0;
        const swipeZone = document.querySelector('.container');

        swipeZone.addEventListener('touchstart', e => {
            touchstartX = e.changedTouches[0].screenX;
        });

        swipeZone.addEventListener('touchend', e => {
            touchendX = e.changedTouches[0].screenX;
            handleGesture();
        });

        function handleGesture() {
            const swipeDistance = touchendX - touchstartX;
            const swipeThreshold = 75;

            if (swipeDistance < -swipeThreshold) {
                const nextIndex = (currentTabIndex + 1) % tabNames.length;
                openTab(tabNames[nextIndex], nextIndex);
            }
            
            if (swipeDistance > swipeThreshold) {
                const prevIndex = (currentTabIndex - 1 + tabNames.length) % tabNames.length;
                openTab(tabNames[prevIndex], prevIndex);
            }
        }

        function showFullPhoto(base64Image) {
            document.getElementById('fullPhoto').src = base64Image;
            document.getElementById('fullPhotoPopupOverlay').style.display = 'flex';
        }

        function closeFullPhotoPopup() {
            document.getElementById('fullPhotoPopupOverlay').style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toLocaleDateString('en-CA');
            document.getElementById('total-date-filter').value = today;
            document.getElementById('date-pacotes').value = today;
            
            loadRecords();
            loadStopRecords();

            const totalPackagesElement = document.getElementById('totalPackagesCount');
            totalPackagesElement.style.cursor = 'pointer';
            totalPackagesElement.addEventListener('click', () => {
                const selectedDate = document.getElementById('total-date-filter').value;
                const totalPackages = parseInt(totalPackagesElement.textContent, 10);
                if (!isNaN(totalPackages)) {
                    const totalReais = totalPackages * 2.50;
                    const dateDisplay = selectedDate ? new Date(selectedDate + 'T00:00:00').toLocaleDateString('pt-BR') : "Total Geral";
                    showCustomPopup(dateDisplay, totalReais.toFixed(2).replace('.', ','));
                }
            });

            document.getElementById('quantity-paradas').addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    saveStopRecord();
                }
            });
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registrado com sucesso:', registration);
                    })
                    .catch(error => {
                        console.log('Falha no registro do Service Worker:', error);
                    });
            });
        }
    </script>
</body>
</html>
    
